<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script>
        function startSim() {
            // constantes
            var hl = {
                castime: 2.5 * 1000,
                mana: 660,
                healMin: 1590,
                healMax: 1770,
                cd: 0,
                coeff: 71.9
            };

            var dl = {
                castime: 2.5 * 1000,
                mana: 920,
                healMin: 2390,
                healMax: 2645,
                cd: 8 * 1000,
                coeff: 71.9
            };
            var dlCoolDown = 0;

            var mana = 0;

            // variables
            var fightLen = document.getElementById("fightLen").value * 60 * 1000; // millisecondes

            var healingPower = document.getElementById("healingPower").value;
            var critChance = document.getElementById("critChance").value;

            var healingLight = document.getElementById("healingLight").checked ? 12 : 0;
            var blessingOfLight = document.getElementById("blessingOfLight").checked ? 400 : 0;

            var timeworn = document.getElementById("timeworn").value * 2;
            var hasteRing = document.getElementById("hasteRing").checked;
            if (hasteRing) {
                hl.castime = hl.castime * (1 - timeworn / 100);
                dl.castime = dl.castime * (1 - timeworn / 100);
            }

            var hpRing = document.getElementById("hpRing").checked;

            var lightGrace = document.getElementById("lightGrace").checked;
            if (lightGrace) {
                hl.castime -= 0.5 * 1000;
                dl.castime -= 0.5 * 1000;
            }

            var aqSet = document.getElementById("aqSet").checked;
            if (aqSet) {
                dl.cd = dl.cd * (1 - 25 / 100);
            }

            // results
            var casting = {
                timer: 0,
                spell: "",
                isCasting: false
            };

            var casted = {
                dl: 0,
                dlCrit: 0,
                hl: 0,
                hlCrit: 0,
            };

            var healed = {
                dl: 0,
                dlHPS: 0,
                dlHealPerCast: 0,
                hl: 0,
                hlHPS: 0,
                hlHealPerCast: 0,
                total: 0,
                totalHPS: 0,
                totalHealPerCast: 0
            };

            for (j = 0; j < 100; j++) {
                for (i = 0; i < fightLen; i++) {
                    // start cast DL
                    if (dlCoolDown <= 0 && !casting.isCasting) {
                        casting.isCasting = true;
                        casting.spell = "dl";
                    } else if (!casting.isCasting) {
                        casting.isCasting = true;
                        casting.spell = "hl";
                    }

                    // end cast DL
                    if (casting.isCasting && casting.spell === "dl" && casting.timer >= dl.castime) {
                        dlCoolDown = dl.cd;
                        casting.isCasting = false;
                        casting.timer = 0;
                        mana = mana - dl.mana;

                        var healMin = dl.healMin * (1 + healingLight / 100) + (healingPower * dl.coeff / 100) + blessingOfLight;
                        var healMax = dl.healMax * (1 + healingLight / 100) + (healingPower * dl.coeff / 100) + blessingOfLight;
                        var healAmount = getAmountHealed(healMin, healMax);

                        var isCrit = getIsCrit(critChance);
                        if (isCrit) {
                            healAmount = healAmount * 1.5;
                            mana = mana + dl.mana;
                            casted.dlCrit++;
                        }

                        if (hpRing) {
                            healAmount = healAmount * (1 + timeworn / 100);
                        }

                        healAmount = Math.floor(healAmount);

                        healed.dl += healAmount;
                        healed.total += healAmount;
                        casted.dl++;
                    }

                    // end cast HL
                    if (casting.isCasting && casting.spell === "hl" && casting.timer >= hl.castime) {
                        casting.isCasting = false;
                        casting.timer = 0;
                        mana = mana - hl.mana;

                        var healMin = hl.healMin * (1 + healingLight / 100) + (healingPower * hl.coeff / 100) + blessingOfLight;
                        var healMax = hl.healMax * (1 + healingLight / 100) + (healingPower * hl.coeff / 100) + blessingOfLight;
                        var healAmount = getAmountHealed(healMin, healMax);

                        var isCrit = getIsCrit(critChance);
                        if (isCrit) {
                            healAmount = healAmount * 1.5;
                            mana = mana + hl.mana;
                            casted.hlCrit++;
                        }

                        if (hpRing) {
                            healAmount = healAmount * (1 + timeworn / 100);
                        }

                        healAmount = Math.floor(healAmount);

                        healed.hl += healAmount;
                        healed.total += healAmount;
                        casted.hl++;
                    }

                    casting.timer++;
                    dlCoolDown--;
                }
            }

            healed.hlHPS = (healed.hl / (fightLen / 1000)) / 100;
            healed.dlHPS = (healed.dl / (fightLen / 1000)) / 100;
            healed.totalHPS = (healed.total / (fightLen / 1000)) / 100;

            healed.hlHealPerCast = healed.hl / casted.hl;
            healed.dlHealPerCast = healed.dl / casted.dl;
            healed.totalHealPerCast = healed.total / (casted.dl + casted.hl);

            document.getElementById("casted_hl").innerHTML = Math.floor(casted.hl / 100);
            document.getElementById("crit_hl").innerHTML = Math.floor(casted.hlCrit / 100);
            document.getElementById("healed_hl").innerHTML = numberFormat(healed.hl / 100);
            document.getElementById("hps_hl").innerHTML = decimalFormat(healed.hlHPS);
            document.getElementById("hpc_hl").innerHTML = decimalFormat(healed.hlHealPerCast);

            document.getElementById("casted_dl").innerHTML = Math.floor(casted.dl / 100);
            document.getElementById("crit_dl").innerHTML = Math.floor(casted.dlCrit / 100);
            document.getElementById("healed_dl").innerHTML = numberFormat(healed.dl / 100);
            document.getElementById("hps_dl").innerHTML = decimalFormat(healed.dlHPS);
            document.getElementById("hpc_dl").innerHTML = decimalFormat(healed.dlHealPerCast);

            document.getElementById("casted_total").innerHTML = Math.floor((casted.dl + casted.hl) / 100);
            document.getElementById("crit_total").innerHTML = Math.floor((casted.dlCrit + casted.hlCrit) / 100);
            document.getElementById("healed_total").innerHTML = numberFormat(healed.total / 100);
            document.getElementById("hps_total").innerHTML = decimalFormat(healed.totalHPS);
            document.getElementById("hpc_total").innerHTML = decimalFormat(healed.totalHealPerCast);

            document.getElementById("mana").innerHTML = decimalFormat(mana / 100);
        }

        function getCritDice() {
            return Math.floor(Math.random() * 100);
        }

        function getIsCrit(critChance) {
            return getCritDice() <= critChance;
        }

        function getAmountHealed(healMin, healMax) {
            return Math.floor(Math.random() * (healMax - healMin + 1) + healMin);
        }

        function decimalFormat(number) {
            return (Math.round(number * 100) / 100).toLocaleString("en-US", { maximumFractionDigits: 2, minimumFractionDigits: 2 });
        }

        function numberFormat(number) {
            return (Math.round(number * 100) / 100).toLocaleString("en-US", { maximumFractionDigits: 0, minimumFractionDigits: 0 });
        }

        document.addEventListener("DOMContentLoaded", function () {
            startSim();

            document.querySelector("form").addEventListener("change", function () {
                startSim();
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <form>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="healingPower">Healing power</label>
                        <input type="number" class="form-control" id="healingPower" placeholder="1000" value="1000">
                    </div>
                    <div class="form-group">
                        <label for="critChance">Crit %</label>
                        <input type="number" class="form-control" id="critChance" placeholder="50" value="50">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="fightLen">Fight duration (min)</label>
                        <input type="number" class="form-control" id="fightLen" placeholder="3" value="3">
                    </div>
                    <div class="form-group">
                        <label for="timeworn">Timeworn items</label>
                        <input type="number" class="form-control" id="timeworn" placeholder="6" value="6">
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="ring" id="hpRing" value="hp">
                        <label class="form-check-label" for="hpRing">Healing Ring</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="ring" id="hasteRing" value="hast">
                        <label class="form-check-label" for="hasteRing">Haste Ring</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="ring" id="noRing" value="">
                        <label class="form-check-label" for="noRing">No Ring</label>
                    </div>
                </div>
                <div class="col">
                    <br />
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="healingLight">
                        <label class="form-check-label" for="healingLight">Healing Light ?</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="blessingOfLight">
                        <label class="form-check-label" for="blessingOfLight">Blessing of Light ?</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="lightGrace">
                        <label class="form-check-label" for="lightGrace">Light Grace ?</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="aqSet">
                        <label class="form-check-label" for="aqSet">T2.5 ?</label>
                    </div>
                </div>
            </div>
        </form>

        <table class="table table-bordered ">
            <thead class="thead-light">
                <tr>
                    <th scope="col">Spell</th>
                    <th>Casted</th>
                    <th>Crit</th>
                    <th>Healed</th>
                    <th>HPS</th>
                    <th>Heal per cast</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>Holy light</th>
                    <td id="casted_hl"></td>
                    <td id="crit_hl"></td>
                    <td id="healed_hl"></td>
                    <td id="hps_hl"></td>
                    <td id="hpc_hl"></td>
                </tr>
                <tr>
                    <th>Divine light</th>
                    <td id="casted_dl"></td>
                    <td id="crit_dl"></td>
                    <td id="healed_dl"></td>
                    <td id="hps_dl"></td>
                    <td id="hpc_dl"></td>
                </tr>
                <tr>
                    <th class="table-success">Total</th>
                    <td id="casted_total"></td>
                    <td id="crit_total"></td>
                    <td id="healed_total"></td>
                    <td id="hps_total"></td>
                    <td id="hpc_total"></td>
                </tr>
            </tbody>
        </table>
        Mana : <span id="mana"></span>
    </div>
</body>
</html>