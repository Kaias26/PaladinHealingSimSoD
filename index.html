<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
            integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8="
            crossorigin="anonymous"></script>
    <script>
        function startSim() {
            // constantes
            var hl = {
                castime: 2.5 * 1000,
                mana: 660,
                healMin: 1590,
                healMax: 1770,
                cd: 0,
                coeff: 71.9
            }

            var dl = {
                castime: 2.5 * 1000,
                mana: 920,
                healMin: 2390,
                healMax: 2645,
                cd: 8 * 1000,
                coeff: 71.9
            }
            var dlCoolDown = 0;

            var mana = 0;

            // variables
            var fightLen = $("#fightLen").val() * 60 * 1000; //milliseconde

            var healingPower = $("#healingPower").val();
            var critChance = $("#critChance").val();

            var healingLight = $("#healingLight").is(':checked') ? 12 : 0;
            var blessingOfLight = $("#blessingOfLight").is(':checked') ? 400 : 0;

            var timeworn = $("#timeworn").val() * 2;
            var hasteRing = $("#hasteRing").is(':checked');
            if (hasteRing) {
                hl.castime = hl.castime * (1 - timeworn / 100);
                dl.castime = dl.castime * (1 - timeworn / 100);
            }

            var hpRing = $("#hpRing").is(':checked');

            var lightGrace = $("#lightGrace").is(':checked');
            if (lightGrace) {
                hl.castime -= 0.5 * 1000;
                dl.castime -= 0.5 * 1000;
            }

            var aqSet = $("#aqSet").is(':checked');
            if (aqSet) {
                dl.cd = dl.cd * (1 - 25 / 100);
            }

            // results
            var casting = {
                timer: 0,
                spell: "",
                isCasting: false
            }

            var casted = {
                dl: 0,
                dlCrit: 0,
                hl: 0,
                hlCrit: 0,
            }

            var healed = {
                dl: 0,
                dlHPS: 0,
                dlHealPerCast: 0,
                hl: 0,
                hlHPS: 0,
                hlHealPerCast: 0,
                total: 0,
                totalHPS: 0,
                totalHealPerCast: 0
            }

            for (j = 0; j < 100; j++) {
                for (i = 0; i < fightLen; i++) {
                    // start cast DL
                    if (dlCoolDown <= 0 && !casting.isCasting) {
                        casting.isCasting = true;
                        casting.spell = "dl";
                    }
                    else if (!casting.isCasting) {
                        casting.isCasting = true;
                        casting.spell = "hl";
                    }

                    // end cast DL
                    if (casting.isCasting && casting.spell == "dl" && casting.timer >= dl.castime) {
                        dlCoolDown = dl.cd;
                        casting.isCasting = false;
                        casting.timer = 0;
                        mana = mana - dl.mana;

                        healMin = dl.healMin * (1 + healingLight / 100) + (healingPower * dl.coeff / 100) + blessingOfLight;
                        healMax = dl.healMax * (1 + healingLight / 100) + (healingPower * dl.coeff / 100) + blessingOfLight;
                        healAmount = getAmountHealed(healMin, healMax);

                        isCrit = getIsCrit(critChance);
                        if (isCrit) {
                            healAmount = healAmount * 1.5;
                            mana = mana + dl.mana;
                            casted.dlCrit++;
                        }

                        if (hpRing) {
                            healAmount = healAmount * (1 + timeworn / 100);
                        }

                        healAmount = Math.floor(healAmount);

                        healed.dl += healAmount;
                        healed.total += healAmount;
                        casted.dl++;

                        //console.log("cast DL for " + healAmount + " " + (isCrit ? "(Crit)" : "") + " (" + i / 1000 + "s)");
                    }

                    // end cast HL
                    if (casting.isCasting && casting.spell == "hl" && casting.timer >= hl.castime) {
                        casting.isCasting = false;
                        casting.timer = 0;
                        mana = mana - hl.mana;

                        healMin = hl.healMin * (1 + healingLight / 100) + (healingPower * hl.coeff / 100) + blessingOfLight;
                        healMax = hl.healMax * (1 + healingLight / 100) + (healingPower * hl.coeff / 100) + blessingOfLight;
                        healAmount = getAmountHealed(healMin, healMax);

                        isCrit = getIsCrit(critChance);
                        if (isCrit) {
                            healAmount = healAmount * 1.5;
                            mana = mana + hl.mana;
                            casted.hlCrit++;
                        }

                        if (hpRing) {
                            healAmount = healAmount * (1 + timeworn / 100);
                        }

                        healAmount = Math.floor(healAmount);

                        healed.hl += healAmount;
                        healed.total += healAmount;
                        casted.hl++;

                        //console.log("cast HL for " + healAmount + " " + (isCrit ? "(Crit)" : "") + " (" + i / 1000 + "s)");
                    }

                    casting.timer++;
                    dlCoolDown--;
                }
            }

            healed.hlHPS = (healed.hl / (fightLen / 1000))/100;
            healed.dlHPS = (healed.dl / (fightLen / 1000))/100;
            healed.totalHPS = (healed.total / (fightLen / 1000))/100;

            healed.hlHealPerCast = (healed.hl / casted.hl);
            healed.dlHealPerCast = (healed.dl / casted.dl);
            healed.totalHealPerCast = (healed.total / (casted.dl + casted.hl));

            $("#casted_hl").html(Math.floor(casted.hl/100));
            $("#crit_hl").html(Math.floor(casted.hlCrit/100));
            $("#healed_hl").html(numberFormat(healed.hl/100));
            $("#hps_hl").html(decimalFormat(healed.hlHPS));
            $("#hpc_hl").html(decimalFormat(healed.hlHealPerCast));

            $("#casted_dl").html(Math.floor(casted.dl/100));
            $("#crit_dl").html(Math.floor(casted.dlCrit/100));
            $("#healed_dl").html(numberFormat(healed.dl/100));
            $("#hps_dl").html(decimalFormat(healed.dlHPS));
            $("#hpc_dl").html(decimalFormat(healed.dlHealPerCast));

            $("#casted_total").html(Math.floor((casted.dl + casted.hl)/100));
            $("#crit_total").html(Math.floor((casted.dlCrit + casted.hlCrit)/100));
            $("#healed_total").html(numberFormat(healed.total/100));
            $("#hps_total").html(decimalFormat(healed.totalHPS));
            $("#hpc_total").html(decimalFormat(healed.totalHealPerCast));

            $("#mana").html(decimalFormat(mana/100));
        }

        function getCritDice() {
            return Math.floor(Math.random() * 100);
        }

        function getIsCrit(critChance) {
            return getCritDice() <= critChance;
        }

        function getAmountHealed(healMin, healMax) {
            return Math.floor(Math.random() * (healMax - healMin + 1) + healMin);
        }

        function decimalFormat(number) {
            return (Math.round(number * 100) / 100).toLocaleString("en-US", { maximumFractionDigits: 2, minimumFractionDigits: 2 });;
        }
        function numberFormat(number) {
            return (Math.round(number * 100) / 100).toLocaleString("en-US", { maximumFractionDigits: 0, minimumFractionDigits: 0 });;
        }
    </script>
</head>
<body>
    <div class="container">
        <form>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="healingPower">Healing power</label>
                        <input type="number" class="form-control" id="healingPower" placeholder="1000" value="1000">
                    </div>
                    <div class="form-group">
                        <label for="critChance">Crit %</label>
                        <input type="number" class="form-control" id="critChance" placeholder="50" value="50">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="fightLen">Fight duration (min)</label>
                        <input type="number" class="form-control" id="fightLen" placeholder="3" value="3">
                    </div>
                    <div class="form-group">
                        <label for="timeworn">Timeworn items</label>
                        <input type="number" class="form-control" id="timeworn" placeholder="6" value="6">
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="ring" id="hpRing" value="hp">
                        <label class="form-check-label" for="hpRing">Healing Ring</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="ring" id="hasteRing" value="hast">
                        <label class="form-check-label" for="hasteRing">Haste Ring</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="ring" id="noRing" value="">
                        <label class="form-check-label" for="noRing">No Ring</label>
                    </div>
                </div>
                <div class="col">
                    <br />
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="healingLight">
                        <label class="form-check-label" for="healingLight">Healing Light ?</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="blessingOfLight">
                        <label class="form-check-label" for="blessingOfLight">Blessing of Light ?</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="lightGrace">
                        <label class="form-check-label" for="lightGrace">Light Grace ?</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="aqSet">
                        <label class="form-check-label" for="aqSet">T2.5 ?</label>
                    </div>
                </div>
            </div>
        </form>

        <table class="table table-bordered ">
            <thead class="thead-light">
                <tr>
                    <th scope="col">Spell</th>
                    <th>Casted</th>
                    <th>Crit</th>
                    <th>Healed</th>
                    <th>HPS</th>
                    <th>Heal per cast</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>Holy light</th>
                    <td id="casted_hl"></td>
                    <td id="crit_hl"></td>
                    <td id="healed_hl"></td>
                    <td id="hps_hl"></td>
                    <td id="hpc_hl"></td>
                </tr>
                <tr>
                    <th>Divine light</th>
                    <td id="casted_dl"></td>
                    <td id="crit_dl"></td>
                    <td id="healed_dl"></td>
                    <td id="hps_dl"></td>
                    <td id="hpc_dl"></td>
                </tr>
                <tr>
                    <th class="table-success">Total</th>
                    <td id="casted_total"></td>
                    <td id="crit_total"></td>
                    <td id="healed_total"></td>
                    <td id="hps_total"></td>
                    <td id="hpc_total"></td>
                </tr>
            </tbody>
        </table>
        Mana : <span id="mana"></span>
    </div>
    <script>
        $(document).ready(function () {
            startSim();

            $('form').on("change", function (e) {
                startSim();
            });
        });
    </script>
</body>
</html>